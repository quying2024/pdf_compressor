# v2.0.1 Hotfix - 修复参数名称错误

## 🐛 问题描述

**发现时间**: 2025-10-19 00:17  
**发现环境**: WSL/Ubuntu 24.04  
**错误类型**: TypeError  
**严重程度**: 🔴 Critical (阻断性bug)

### 错误信息
```
TypeError: reconstruct_pdf() got an unexpected keyword argument 'images'
```

### 错误日志
```
2025-10-19 00:17:42,497 - ERROR - [strategy:226] - 执行方案 S1-保守 时发生意外错误: 
reconstruct_pdf() got an unexpected keyword argument 'images'
Traceback (most recent call last):
  File "/home/quying/pdf_compressor/compressor/strategy.py", line 213, in _execute_scheme
    success = pipeline.reconstruct_pdf(
              ^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: reconstruct_pdf() got an unexpected keyword argument 'images'
```

### 影响范围
- ❌ **所有压缩操作失败**
- ❌ 无法执行任何方案（S1-S6）
- ❌ 导致拆分操作也无法进行
- ⚠️ v2.0.0版本完全无法使用

---

## 🔍 根本原因分析

### 问题根源
在 `compressor/strategy.py` 的 `_execute_scheme()` 函数中，调用 `pipeline.reconstruct_pdf()` 时使用了错误的参数名称。

### 代码对比

#### ❌ 错误代码 (v2.0.0)
```python
# strategy.py 第213行
success = pipeline.reconstruct_pdf(
    images=precomputed_data['image_files'],      # ❌ 错误参数名
    hocr=precomputed_data['hocr_file'],          # ❌ 错误参数名
    temp_dir=temp_dir,
    params=params,
    output_pdf_path=output_pdf_path
)
```

#### ✅ 正确代码 (v2.0.1)
```python
# strategy.py 第213行
success = pipeline.reconstruct_pdf(
    image_files=precomputed_data['image_files'], # ✅ 正确参数名
    hocr_file=precomputed_data['hocr_file'],     # ✅ 正确参数名
    temp_dir=temp_dir,
    params=params,
    output_pdf_path=output_pdf_path
)
```

#### 📋 函数签名
```python
# pipeline.py 第114行
def reconstruct_pdf(image_files, hocr_file, temp_dir, params, output_pdf_path):
    """使用 recode_pdf 重建 PDF。"""
```

### 为什么会出现这个错误？

1. **单元测试局限性**: 
   - 单元测试使用了mock对象
   - Mock对象不验证参数名称
   - 仅验证了逻辑流程，未执行真实函数

2. **集成测试缺失**:
   - v2.0.0发布前未进行端到端集成测试
   - 未在实际环境中运行完整流程
   - 未使用真实PDF文件测试

3. **代码审查遗漏**:
   - 重构时修改了参数名但未同步更新调用处
   - 代码审查时未发现参数不一致

---

## 🔧 修复方案

### 修改文件
- `compressor/strategy.py` (1个文件)

### 修改内容
```diff
--- a/compressor/strategy.py
+++ b/compressor/strategy.py
@@ -211,8 +211,8 @@ def _execute_scheme(scheme_id, precomputed_data, temp_dir, target_size_mb):
 
     try:
         success = pipeline.reconstruct_pdf(
-            images=precomputed_data['image_files'],
-            hocr=precomputed_data['hocr_file'],
+            image_files=precomputed_data['image_files'],
+            hocr_file=precomputed_data['hocr_file'],
             temp_dir=temp_dir,
             params=params,
             output_pdf_path=output_pdf_path
```

### 提交信息
```
commit 211141a
Author: quying2024
Date:   2025-10-19

fix: 修复reconstruct_pdf参数名称错误

- 将 images 改为 image_files
- 将 hocr 改为 hocr_file
- 修复TypeError: reconstruct_pdf() got an unexpected keyword argument
```

---

## ✅ 验证测试

### 测试环境
- WSL/Ubuntu 24.04
- Python 3.13.7

### 测试步骤
修复后，请在WSL环境中执行以下测试：

```bash
# 1. 拉取最新代码
cd ~/pdf_compressor
git pull origin main

# 2. 测试单文件压缩
python main.py --input test.pdf --output ./output --verbose

# 3. 测试带拆分的压缩
python main.py --input large.pdf --output ./output --allow-splitting --verbose

# 4. 检查日志
tail -f logs/process.log
```

### 预期结果
- ✅ 不再出现 `TypeError: reconstruct_pdf()` 错误
- ✅ 方案S1能够正常执行
- ✅ 压缩流程正常完成
- ✅ 拆分流程（如需要）正常工作

---

## 📊 影响评估

### 受影响版本
- ❌ v2.0.0 (完全无法使用)

### 修复版本
- ✅ v2.0.1 (已修复)

### 用户影响
- **已下载v2.0.0的用户**: 需要立即更新
- **新用户**: 直接使用v2.0.1
- **生产环境**: 如已部署v2.0.0，必须紧急更新

---

## 🎯 预防措施

### 已采取的措施
1. ✅ 修复代码并提交
2. ✅ 推送到远程仓库
3. ✅ 创建修复文档

### 将来的改进

#### 1. 加强集成测试
```python
# 新增: tests/test_integration.py
def test_real_pdf_compression():
    """使用真实PDF文件进行端到端测试"""
    real_pdf = Path("test_data/sample.pdf")
    output_dir = Path("test_output")
    
    status, details = run_compression_strategy(
        real_pdf, output_dir, target_size_mb=2.0
    )
    
    assert status == 'success'
    assert details['output_path'].exists()
```

#### 2. 添加参数验证
```python
# 在 pipeline.py 中添加
def reconstruct_pdf(image_files, hocr_file, temp_dir, params, output_pdf_path):
    """使用 recode_pdf 重建 PDF。"""
    # 参数验证
    if not isinstance(image_files, list):
        raise TypeError(f"image_files must be list, got {type(image_files)}")
    if not isinstance(hocr_file, Path):
        raise TypeError(f"hocr_file must be Path, got {type(hocr_file)}")
    ...
```

#### 3. 使用类型提示
```python
from typing import List, Dict
from pathlib import Path

def reconstruct_pdf(
    image_files: List[Path], 
    hocr_file: Path, 
    temp_dir: Path, 
    params: Dict[str, int], 
    output_pdf_path: Path
) -> bool:
    """使用 recode_pdf 重建 PDF。"""
    ...
```

#### 4. 发布前检查清单
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 在真实环境中测试
- [ ] 使用真实PDF文件测试
- [ ] 参数验证检查
- [ ] 代码审查
- [ ] 文档更新

---

## 📝 更新日志

### v2.0.1 (2025-10-19) - Hotfix

#### 🐛 Bug修复
- **Critical**: 修复 `reconstruct_pdf()` 参数名称错误
  - `images` → `image_files`
  - `hocr` → `hocr_file`
  - 解决v2.0.0完全无法使用的问题

#### 📦 文件变更
- `compressor/strategy.py`: 2处参数名称修复

#### ⚠️ 重要提示
- **所有v2.0.0用户必须立即更新到v2.0.1**
- v2.0.0版本存在阻断性bug，无法正常工作

---

## 🚀 升级指南

### 从v2.0.0升级

#### Git仓库用户
```bash
cd ~/pdf_compressor
git pull origin main
# 现在是v2.0.1，问题已修复
```

#### 直接下载用户
```bash
# 重新下载v2.0.1
git clone https://github.com/quying2024/pdf_compressor.git
cd pdf_compressor
git checkout v2.0.1  # 或直接使用main分支
```

---

## 📞 支持信息

如果升级后仍有问题，请：

1. **检查版本**:
   ```bash
   cd ~/pdf_compressor
   git log --oneline -1
   # 应显示: 211141a fix: 修复reconstruct_pdf参数名称错误
   ```

2. **查看日志**:
   ```bash
   tail -f logs/process.log
   ```

3. **提交Issue**:
   - GitHub Issues: https://github.com/quying2024/pdf_compressor/issues

---

**修复时间**: 2025-10-19  
**修复人**: quying2024  
**状态**: ✅ 已修复并推送到远程仓库  
**紧急程度**: 🔴 Critical - 立即更新
